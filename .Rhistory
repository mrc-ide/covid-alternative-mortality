Min_cvd_deaths + cvd_death_prev * Unacc_Deaths_Attrib
Cap*(3600-sum(TotSamDeaths*Sampling))/(sum(Cap)
)
Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)
)
Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap))
as.Date("2020-10-01")-as.Date("2020-06-15")
107/108*3676
106/108*3676
BMJdata$TotSamDeaths
sum(BMJdata$TotSamDeaths)
sum(TotSamDeaths)
TotSamDeaths
sum(TotSamDeaths*Sampling)
3600-sum(TotSamDeaths*Sampling)
Cap
Cap*(3600-sum(TotSamDeaths*Sampling))
Cap*(3600-sum(TotSamDeaths*Sampling))/(sum(Cap))
sum(Cap*(3600-sum(TotSamDeaths*Sampling))/(sum(Cap)))
CovSamDeaths
CovSamDeaths/TotSamDeaths
BMJdata %>%
mutate(total_sample_effort = (CovSamDeaths*Sampling + CovSamDeaths/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8,
TotEstCovDeathsLus_High_Est_Strict = (CovSamDeaths_Strict*Sampling + CovSamDeaths_Strict/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8)
# from https://www.bmj.com/content/372/bmj.n334
BMJdata <- read.csv("analysis/data/raw/lusaka_bmj_data.rds")
# different methods to understand sampling effort
BMJdata <- BMJdata %>%
mutate(total_burial_registry_comp = CovSamDeaths*(364/3676), # 3676 deaths during this period
total_burial_registry_comp_strict = CovSamDeaths_Strict*(364/3676), # 3676 deaths during this period
Sampling = c(5,5,5,5,3,3,3*1/10+2*9/10,2),  # Sampling was 1 in 5 for June, July, 1 in 3 for Aug, 1 in 2 for Sep.
Cap = c(1,1,1,1,1,1,1/10,0)) # Daily tests were capped at 5 or 6 in June, July and Aug. No cap in Sep.
# from https://www.bmj.com/content/372/bmj.n334
BMJdata <- read.csv("analysis/data/raw/lusaka_bmj_data.rds")
# from https://www.bmj.com/content/372/bmj.n334
BMJdata <- read.csv("analysis/data/raw/lusaka_bmj_data.csv")
# different methods to understand sampling effort
BMJdata <- BMJdata %>%
mutate(total_burial_registry_comp = CovSamDeaths*(364/3676), # 3676 deaths during this period
total_burial_registry_comp_strict = CovSamDeaths_Strict*(364/3676), # 3676 deaths during this period
Sampling = c(5,5,5,5,3,3,3*1/10+2*9/10,2),  # Sampling was 1 in 5 for June, July, 1 in 3 for Aug, 1 in 2 for Sep.
Cap = c(1,1,1,1,1,1,1/10,0)) # Daily tests were capped at 5 or 6 in June, July and Aug. No cap in Sep.
BMJdata <- BMJdata %>%
mutate(total_sample_effort = (CovSamDeaths*Sampling + CovSamDeaths/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8,
total_sample_effort_strict = (CovSamDeaths_Strict*Sampling + CovSamDeaths_Strict/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8)
# Break down BMJ data by day:
BMJdata <- BMJdata %>% mutate(TimePeriod = 1:8) # Assign week labels to BMJ data
BMJdata
BMJdataTotEsts
# Take the total number of estimated deaths in Lusaka
# Deduct the ones that were officially reported, and distribute the other deaths evenly
# 10x, lower limit and higher limit.
BMJdata_to_fit <- BMJdata %>%
mutate(total_burial_registry_comp = rep((BMJdata$TotEstCovDeathsLus_10x)/14, each = 14),
total_burial_registry_comp_strict = rep((BMJdata$TotEstCovDeathsLus_Low_Est)/14, each = 14),
total_sample_effort = rep((BMJdata$TotEstCovDeathsLus_High_Est)/14, each = 14),
total_sample_effort_strict = rep((BMJdata$TotEstCovDeathsLus_High_Est_Strict)/14, each = 14))
# Take the total number of estimated deaths in Lusaka
# Deduct the ones that were officially reported, and distribute the other deaths evenly
# 10x, lower limit and higher limit.
BMJdata_to_fit <- BMJdata %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/14, each = 14),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/14, each = 14),
total_sample_effort = rep((BMJdata$total_sample_effort)/14, each = 14),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/14, each = 14))
# from https://www.bmj.com/content/372/bmj.n334
BMJdata <- read.csv("analysis/data/raw/lusaka_bmj_data.csv")
# different methods to understand sampling effort
BMJdata <- BMJdata %>%
mutate(total_burial_registry_comp = CovSamDeaths*(364/3676), # 3676 deaths during this period
total_burial_registry_comp_strict = CovSamDeaths_Strict*(364/3676), # 3676 deaths during this period
Sampling = c(5,5,5,5,3,3,3*1/10+2*9/10,2),  # Sampling was 1 in 5 for June, July, 1 in 3 for Aug, 1 in 2 for Sep.
Cap = c(1,1,1,1,1,1,1/10,0)) # Daily tests were capped at 5 or 6 in June, July and Aug. No cap in Sep.
BMJdata <- BMJdata %>%
mutate(total_sample_effort = (CovSamDeaths*Sampling + CovSamDeaths/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8,
total_sample_effort_strict = (CovSamDeaths_Strict*Sampling + CovSamDeaths_Strict/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8)
BMJdata
# different methods to understand sampling effort
BMJdata <- BMJdata %>%
mutate(total_burial_registry_comp = CovSamDeaths*(3676/364), # 3676 deaths during this period
total_burial_registry_comp_strict = CovSamDeaths_Strict*(3676/364), # 3676 deaths during this period
Sampling = c(5,5,5,5,3,3,3*1/10+2*9/10,2),  # Sampling was 1 in 5 for June, July, 1 in 3 for Aug, 1 in 2 for Sep.
Cap = c(1,1,1,1,1,1,1/10,0)) # Daily tests were capped at 5 or 6 in June, July and Aug. No cap in Sep.
# from https://www.bmj.com/content/372/bmj.n334
BMJdata <- read.csv("analysis/data/raw/lusaka_bmj_data.csv")
# different methods to understand sampling effort
BMJdata <- BMJdata %>%
mutate(total_burial_registry_comp = CovSamDeaths*(3676/364), # 3676 deaths during this period
total_burial_registry_comp_strict = CovSamDeaths_Strict*(3676/364), # 3676 deaths during this period
Sampling = c(5,5,5,5,3,3,3*1/10+2*9/10,2),  # Sampling was 1 in 5 for June, July, 1 in 3 for Aug, 1 in 2 for Sep.
Cap = c(1,1,1,1,1,1,1/10,0)) # Daily tests were capped at 5 or 6 in June, July and Aug. No cap in Sep.
BMJdata <- BMJdata %>%
mutate(total_sample_effort = (CovSamDeaths*Sampling + CovSamDeaths/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8,
total_sample_effort_strict = (CovSamDeaths_Strict*Sampling + CovSamDeaths_Strict/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8)
# Break down BMJ data by day:
BMJdata <- BMJdata %>% mutate(TimePeriod = 1:8) # Assign week labels to BMJ data
BMJdata
# Take the total number of estimated deaths in Lusaka
# Deduct the ones that were officially reported, and distribute the other deaths evenly
# 10x, lower limit and higher limit.
BMJdata_to_fit <- BMJdata %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/14, each = 14),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/14, each = 14),
total_sample_effort = rep((BMJdata$total_sample_effort)/14, each = 14),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/14, each = 14))
BMJdata
BMJdata$total_burial_registry_comp
rep((BMJdata$total_burial_registry_comp)/14, each = 14)
rep((BMJdata$total_burial_registry_comp_strict)/14, each = 14)
rep((BMJdata$total_sample_effort)/14, each = 14)
#
df_off_dil <- read.csv("analysis/data/raw/zambia_official_covid.csv")
df_off_dil
#
df_off_zambia <- read.csv("analysis/data/raw/zambia_official_covid.csv")
df_off_lusaka <- df_off_zambia %>%
mutate(date = as.Date(Date), deaths = Total_Deaths) %>%
filter(Province=="Lusaka" & date < "2020-11-01") %>%
select(date, deaths) %>% na.omit() %>%
group_by(date) %>% summarise(deaths = sum(deaths))
df_off_lusaka
df_off_lusaka <- df_off_zambia %>%
mutate(date = as.Date(Date), deaths = Total_Deaths) %>%
filter(Province=="Lusaka" & date < "2020-11-01") %>%
select(date, deaths) %>% na.omit() %>%
group_by(date) %>%
summarise(deaths = sum(deaths)) %>%
complete(date = seq.Date(min(date), max(date), 1))
df_off_lusaka
# and now merge with the lusaka official data
df_off_zambia <- read.csv("analysis/data/raw/zambia_official_covid.csv")
df_off_lusaka <- df_off_zambia %>%
mutate(date = as.Date(Date), deaths = Total_Deaths) %>%
filter(Province=="Lusaka" & date < "2020-11-01") %>%
select(date, deaths) %>% na.omit() %>%
group_by(date) %>%
summarise(deaths = sum(deaths)) %>%
complete(date = seq.Date(min(date), max(date), 1)) %>%
mutate(deaths = replace_na(deaths, 0)) %>%
filter(date >= "2020-06-08" & date <= "2020-09-27")
df_off_lusaka
BMJdata_to_fit <- df_off_lusaka %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/14, each = 14),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/14, each = 14),
total_sample_effort = rep((BMJdata$total_sample_effort)/14, each = 14),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/14, each = 14))
BMJdata_to_fit
sum(BMJdata_to_fit$deaths)
sum(BMJdata_to_fit$total_burial_registry_comp)
sum(BMJdata_to_fit$total_burial_registry_comp_strict)
sum(BMJdata_to_fit$total_sample_effort)
sum(BMJdata_to_fit$total_sample_effort_strict)
# from https://www.bmj.com/content/372/bmj.n334
BMJdata <- read.csv("analysis/data/raw/lusaka_bmj_data.csv")
# different methods to understand sampling effort
BMJdata <- BMJdata %>%
mutate(total_burial_registry_comp = CovSamDeaths*(3676/364)/0.8, # 3676 deaths during this period
total_burial_registry_comp_strict = CovSamDeaths_Strict*(3676/364)/0.8, # 3676 deaths during this period
Sampling = c(5,5,5,5,3,3,3*1/10+2*9/10,2),  # Sampling was 1 in 5 for June, July, 1 in 3 for Aug, 1 in 2 for Sep.
Cap = c(1,1,1,1,1,1,1/10,0)) # Daily tests were capped at 5 or 6 in June, July and Aug. No cap in Sep.
BMJdata <- BMJdata %>%
mutate(total_sample_effort = (CovSamDeaths*Sampling + CovSamDeaths/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8,
total_sample_effort_strict = (CovSamDeaths_Strict*Sampling + CovSamDeaths_Strict/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8)
# and now merge with the lusaka official data
df_off_zambia <- read.csv("analysis/data/raw/zambia_official_covid.csv")
df_off_lusaka <- df_off_zambia %>%
mutate(date = as.Date(Date), deaths = Total_Deaths) %>%
filter(Province=="Lusaka" & date < "2020-11-01") %>%
select(date, deaths) %>% na.omit() %>%
group_by(date) %>%
summarise(deaths = sum(deaths)) %>%
complete(date = seq.Date(min(date), max(date), 1)) %>%
mutate(deaths = replace_na(deaths, 0)) %>%
filter(date >= "2020-06-08" & date <= "2020-09-27")
BMJdata_to_fit <- df_off_lusaka %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/14, each = 14),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/14, each = 14),
total_sample_effort = rep((BMJdata$total_sample_effort)/14, each = 14),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/14, each = 14))
BMJdata_to_fit$total_burial_registry_comp
squire:::run_deterministic_comparison
squire:::ll_nbinom
squire:::ll_nbinom(1.5, 3, phi = 1, k = 2, exp_noise = 1e-6)
squire:::ll_nbinom(2, 3, phi = 1, k = 2, exp_noise = 1e-6)
squire.page:::pmcmc_excess
?squire:::calc_loglikelihood
devtools::build()
df_off_lusaka
BMJdata_to_fit
BMJdata
BMJdata_to_fit
BMJdata_to_fit$deaths %>% sum
BMJdata_to_fit$total_burial_registry_comp %>% sum
round(BMJdata_to_fit$total_burial_registry_comp) %>% sum
BMJdata
# from https://www.bmj.com/content/372/bmj.n334
BMJdata <- read.csv("analysis/data/raw/lusaka_bmj_data.csv")
# different methods to understand sampling effort
BMJdata <- BMJdata %>%
mutate(total_burial_registry_comp = round(CovSamDeaths*(3676/364)/0.8), # 3676 deaths during this period
total_burial_registry_comp_strict = round(CovSamDeaths_Strict*(3676/364)/0.8), # 3676 deaths during this period
Sampling = c(5,5,5,5,3,3,3*1/10+2*9/10,2),  # Sampling was 1 in 5 for June, July, 1 in 3 for Aug, 1 in 2 for Sep.
Cap = c(1,1,1,1,1,1,1/10,0)) # Daily tests were capped at 5 or 6 in June, July and Aug. No cap in Sep.
BMJdata <- BMJdata %>%
mutate(total_sample_effort = round((CovSamDeaths*Sampling + CovSamDeaths/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8),
total_sample_effort_strict = round((CovSamDeaths_Strict*Sampling + CovSamDeaths_Strict/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8))
# and now merge with the lusaka official data
df_off_zambia <- read.csv("analysis/data/raw/zambia_official_covid.csv")
df_off_lusaka <- df_off_zambia %>%
mutate(date = as.Date(Date), deaths = Total_Deaths) %>%
filter(Province=="Lusaka" & date < "2020-11-01") %>%
select(date, deaths) %>% na.omit() %>%
group_by(date) %>%
summarise(deaths = sum(deaths)) %>%
complete(date = seq.Date(min(date), max(date), 1)) %>%
mutate(deaths = replace_na(deaths, 0)) %>%
filter(date >= "2020-06-08" & date <= "2020-09-27")
BMJdata_to_fit <- df_off_lusaka %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/14, each = 14),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/14, each = 14),
total_sample_effort = rep((BMJdata$total_sample_effort)/14, each = 14),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/14, each = 14))
BMJdata_to_fit
# from https://www.bmj.com/content/372/bmj.n334
BMJdata <- read.csv("analysis/data/raw/lusaka_bmj_data.csv")
# different methods to understand sampling effort
BMJdata <- BMJdata %>%
mutate(total_burial_registry_comp = round(CovSamDeaths*(3676/364)/0.8), # 3676 deaths during this period
total_burial_registry_comp_strict = round(CovSamDeaths_Strict*(3676/364)/0.8), # 3676 deaths during this period
Sampling = c(5,5,5,5,3,3,3*1/10+2*9/10,2),  # Sampling was 1 in 5 for June, July, 1 in 3 for Aug, 1 in 2 for Sep.
Cap = c(1,1,1,1,1,1,1/10,0)) # Daily tests were capped at 5 or 6 in June, July and Aug. No cap in Sep.
BMJdata <- BMJdata %>%
mutate(total_sample_effort = round((CovSamDeaths*Sampling + CovSamDeaths/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8),
total_sample_effort_strict = round((CovSamDeaths_Strict*Sampling + CovSamDeaths_Strict/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8))
BMJdata
# and now merge with the lusaka official data
df_off_zambia <- read.csv("analysis/data/raw/zambia_official_covid.csv")
df_off_lusaka <- df_off_zambia %>%
mutate(date = as.Date(Date), deaths = Total_Deaths) %>%
filter(Province=="Lusaka" & date < "2020-11-01") %>%
select(date, deaths) %>% na.omit() %>%
group_by(date) %>%
summarise(deaths = sum(deaths)) %>%
complete(date = seq.Date(min(date), max(date), 1)) %>%
mutate(deaths = replace_na(deaths, 0)) %>%
filter(date >= "2020-06-08" & date <= "2020-09-27")
BMJdata
BMJdata_to_fit <- df_off_lusaka %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/14, each = 14),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/14, each = 14),
total_sample_effort = rep((BMJdata$total_sample_effort)/14, each = 14),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/14, each = 14))
BMJdata_to_fit
BMJdata_to_fit <- df_off_lusaka %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/14, each = 14),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/14, each = 14),
total_sample_effort = rep((BMJdata$total_sample_effort)/14, each = 14),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/14, each = 14)) %>%
mutate(across(total_burial_registry_comp:total_sample_effort_strict, round))
BMJdata_to_fit
BMJdata_to_fit %>% pivot_longer(-1:2)
BMJdata_to_fit %>% pivot_longer(-(1:2))
BMJdata_to_fit %>% pivot_longer(-(1:2)) %>% ggplot(aes(date, deaths)) + geom_line()
BMJdata_to_fit %>% pivot_longer(-(1:2)) %>% ggplot(aes(date, deaths, color = name)) + geom_line()
BMJdata_to_fit <- df_off_lusaka %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/14, each = 14),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/14, each = 14),
total_sample_effort = rep((BMJdata$total_sample_effort)/14, each = 14),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/14, each = 14))
BMJdata_to_fit %>% pivot_longer(-(1:2)) %>% ggplot(aes(date, deaths, color = name)) + geom_line()
# different methods to understand sampling effort
BMJdata <- BMJdata %>%
mutate(total_burial_registry_comp = CovSamDeaths*(3676/364)/0.8, # 3676 deaths during this period
total_burial_registry_comp_strict = CovSamDeaths_Strict*(3676/364)/0.8, # 3676 deaths during this period
Sampling = c(5,5,5,5,3,3,3*1/10+2*9/10,2),  # Sampling was 1 in 5 for June, July, 1 in 3 for Aug, 1 in 2 for Sep.
Cap = c(1,1,1,1,1,1,1/10,0)) # Daily tests were capped at 5 or 6 in June, July and Aug. No cap in Sep.
BMJdata <- BMJdata %>%
mutate(total_sample_effort = (CovSamDeaths*Sampling + CovSamDeaths/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8,
total_sample_effort_strict = (CovSamDeaths_Strict*Sampling + CovSamDeaths_Strict/TotSamDeaths * Cap*(3676-sum(TotSamDeaths*Sampling))/(sum(Cap)))/0.8)
# and now merge with the lusaka official data
df_off_zambia <- read.csv("analysis/data/raw/zambia_official_covid.csv")
df_off_lusaka <- df_off_zambia %>%
mutate(date = as.Date(Date), deaths = Total_Deaths) %>%
filter(Province=="Lusaka" & date < "2020-11-01") %>%
select(date, deaths) %>% na.omit() %>%
group_by(date) %>%
summarise(deaths = sum(deaths)) %>%
complete(date = seq.Date(min(date), max(date), 1)) %>%
mutate(deaths = replace_na(deaths, 0)) %>%
filter(date >= "2020-06-08" & date <= "2020-09-27")
BMJdata_to_fit <- df_off_lusaka %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/14, each = 14),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/14, each = 14),
total_sample_effort = rep((BMJdata$total_sample_effort)/14, each = 14),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/14, each = 14)) %>%
mutate(across(total_burial_registry_comp:total_sample_effort_strict, round))
BMJdata_to_fit %>% pivot_longer(-(1:2)) %>% ggplot(aes(date, deaths, color = name)) + geom_line()
BMJdata_to_fit <- df_off_lusaka %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/14, each = 14),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/14, each = 14),
total_sample_effort = rep((BMJdata$total_sample_effort)/14, each = 14),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/14, each = 14))
BMJdata_to_fit %>% pivot_longer(-(1:2)) %>% ggplot(aes(date, deaths, color = name)) + geom_line()
df_off_lusaka
BMJdata_to_fit
BMJdata_to_fit %>% pivot_longer(-(1:2))
BMJdata_to_fit %>% pivot_longer(-(1:2)) %>% ggplot(aes(date, deaths, color = name)) + geom_step()
BMJdata_to_fit %>% pivot_longer(-(1:2)) %>% ggplot(aes(date, deaths, color = name, group = name)) + geom_step()
BMJdata_to_fit %>% summarise(across(-(1:2), sum))
BMJdata_to_fit %>% mutate(across(-(1:2), round)) %>% summarise(across(-(1:2), sum))
BMJdata
df_off_lusaka
102/7
102/14
BMJdata_to_fit <- df_off_lusaka %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/14, each = 14),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/14, each = 14),
total_sample_effort = rep((BMJdata$total_sample_effort)/14, each = 14),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/14, each = 14)) %>%
mutate(across(total_burial_registry_comp:total_sample_effort_strict, round))
dim(BMJdata_to_fit)
112/14
seq(1, 106, 7)
BMJdata_to_fit <- df_off_lusaka[seq(1, 106, 7),] %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/2, each = 2),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/2, each = 2),
total_sample_effort = rep((BMJdata$total_sample_effort)/2, each = 2),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/2, each = 2)) %>%
mutate(across(total_burial_registry_comp:total_sample_effort_strict, round))
BMJdata_to_fit
# and now merge with the lusaka official data
df_off_zambia <- read.csv("analysis/data/raw/zambia_official_covid.csv")
df_off_lusaka <- df_off_zambia %>%
mutate(date = as.Date(Date), deaths = Total_Deaths) %>%
filter(Province=="Lusaka" & date < "2020-11-01") %>%
select(date, deaths) %>% na.omit() %>%
group_by(date) %>%
summarise(deaths = sum(deaths)) %>%
complete(date = seq.Date(min(date), max(date), 1)) %>%
mutate(deaths = replace_na(deaths, 0)) %>%
filter(date >= "2020-06-08" & date <= "2020-09-27") %>%
mutate(deaths = cumsum(deaths))
BMJdata_to_fit <- df_off_lusaka[seq(1, 106, 7),, "date"] %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/2, each = 2),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/2, each = 2),
total_sample_effort = rep((BMJdata$total_sample_effort)/2, each = 2),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/2, each = 2)) %>%
mutate(across(total_burial_registry_comp:total_sample_effort_strict, round))
# and now merge with the lusaka official data
df_off_zambia <- read.csv("analysis/data/raw/zambia_official_covid.csv")
df_off_lusaka <- df_off_zambia %>%
mutate(date = as.Date(Date), deaths = Total_Deaths) %>%
filter(Province=="Lusaka" & date < "2020-11-01") %>%
select(date, deaths) %>% na.omit() %>%
group_by(date) %>%
summarise(deaths = sum(deaths)) %>%
complete(date = seq.Date(min(date), max(date), 1)) %>%
mutate(deaths = replace_na(deaths, 0)) %>%
filter(date >= "2020-06-08" & date <= "2020-09-27") %>%
mutate(deaths = cumsum(deaths))
df_off_lusaka
BMJdata_to_fit <- df_off_lusaka[seq(1, 106, 7),] %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/2, each = 2),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/2, each = 2),
total_sample_effort = rep((BMJdata$total_sample_effort)/2, each = 2),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/2, each = 2)) %>%
mutate(across(total_burial_registry_comp:total_sample_effort_strict, round))
BMJdata_to_fit
BMJdata_to_fit <- df_off_lusaka[seq(1, 106, 7),] %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/2, each = 2),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/2, each = 2),
total_sample_effort = rep((BMJdata$total_sample_effort)/2, each = 2),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/2, each = 2)) %>%
mutate(across(total_burial_registry_comp:total_sample_effort_strict, round)) %>%
mutate(deaths = c(0, diff(deaths)))
BMJdata_to_fit
addis_covid_deaths <- readRDS("~/GoogleDrive/AcademicWork/covid/githubs/covid-alternative-mortality/analysis/data/derived/deaths_time_series/addis_covid_deaths.rds")
head(addis_covid_deaths)
BMJdata_to_fit <- df_off_lusaka[seq(1, 106, 7),] %>%
mutate(total_burial_registry_comp = rep((BMJdata$total_burial_registry_comp)/2, each = 2),
total_burial_registry_comp_strict = rep((BMJdata$total_burial_registry_comp_strict)/2, each = 2),
total_sample_effort = rep((BMJdata$total_sample_effort)/2, each = 2),
total_sample_effort_strict = rep((BMJdata$total_sample_effort_strict)/2, each = 2)) %>%
mutate(across(total_burial_registry_comp:total_sample_effort_strict, round)) %>%
mutate(official_covid_deaths = c(0, diff(deaths))) %>%
select(-deaths)
BMJdata_to_fit
saveRDS(BMJdata_to_fit,"analysis/data/derived/deaths_time_series/lusaka_postmortem_deaths.rds")
names(BMJdata_to_fit)
names(BMJdata_to_fit)[2:5]
c(names(BMJdata_to_fit)[2:5])
deaths <- readRDS("analysis/data/derived/deaths_time_series/lusaka_postmortem_deaths.rds")
death_source = "total_burial_registry_comp"
deaths <- readRDS("analysis/data/derived/deaths_time_series/lusaka_postmortem_deaths.rds")
lusaka_data <- deaths[date, death_source]
lusaka_data
deaths <- readRDS("analysis/data/derived/deaths_time_series/lusaka_postmortem_deaths.rds")
deaths
lusaka_data <- deaths[ ,c("date", death_source)]
lusaka_data
devtools::load_all()
devtools::build()
devtools::load_all()
devtools::build()
lusaka_data
lusaka_pop
# 2020 Age distribution for Lusaka Province from opendataforafrica scales for 2020 total
# (https://zambia.opendataforafrica.org/thrqjfb/population-and-demographic-projections-2011-2035?regionId=ZM-09)
lusaka_pop <- c(549475,448008,379841,339600,317148,305521,271318,232188,172365,125531,75157,51883,35587,22219,14960,8570,10812)
n_mcmc <- 5000
fit <- fit_spline_rt(data=lusaka_data,
country="Zambia",
population=lusaka_pop,
reporting_fraction=1,
n_mcmc = n_mcmc,
replicates = 10,
rw_duration = 14,
log_likelihood = lusaka_log_likelihood,
hosp_beds = 1e10,
icu_beds = 1e10)
lusaka_data
data <- lusaka_data
# dat_0 is just the current date now
date_0 <- max(data$date)
# what is the date of first death
null_na <- function(x) {if(is.null(x)) {NA} else {x}}
min_death_date <- data$date[which(data$deaths>0)][1]
# We set the R0_change here to be 1 everywhere to effectively turn off mobility
R0_change <- rep(1, nrow(data))
date_R0_change <- data$date
R0_change <- R0_change[as.Date(date_R0_change) <= date_0]
date_R0_change <- date_R0_change[as.Date(date_R0_change) <= date_0]
names(lusaka_data) <- c("date", "deaths")
data <- lusaka_data
fit <- fit_spline_rt(data=lusaka_data,
country="Zambia",
population=lusaka_pop,
reporting_fraction=1,
n_mcmc = n_mcmc,
replicates = 10,
rw_duration = 14,
log_likelihood = lusaka_log_likelihood,
hosp_beds = 1e10,
icu_beds = 1e10)
devtools::build()
fit <- fit_spline_rt(data=lusaka_data,
country="Zambia",
population=lusaka_pop,
reporting_fraction=1,
n_mcmc = n_mcmc,
replicates = 10,
rw_duration = 14,
log_likelihood = lusaka_log_likelihood,
hosp_beds = 1e10,
icu_beds = 1e10)
Sys.setenv("SQUIRE_PARALLEL_DEBUG" = TRUE)
fit <- fit_spline_rt(data=lusaka_data,
country="Zambia",
population=lusaka_pop,
reporting_fraction=1,
n_mcmc = n_mcmc,
replicates = 10,
rw_duration = 14,
log_likelihood = lusaka_log_likelihood,
hosp_beds = 1e10,
icu_beds = 1e10)
devtools::load_all(".")
n_mcmc <- 100
rf = 0.3
death_source <- "official"
lusaka_pop <- c(549475,448008,379841,339600,317148,305521,271318,232188,172365,125531,75157,51883,35587,22219,14960,8570,10812)
# get our deaths source
deaths <- readRDS("analysis/data/derived/deaths_time_series/lusaka_official_deaths.rds")
lusaka_data <- deaths
log_likelihood <- NULL
starting_pars <- list(
"start_date" = as.Date("2020-04-27"),
"R0" = 3.982342,
"Meff" = -0.4017083,
"Meff_pl" = 0.5332879,
"Rt_shift" = 0.0004747717,
"Rt_shift_scale" = 9.03734,
"Rt_rw_1" = 0.3629854,
"Rt_rw_2" = 0.5454458,
"Rt_rw_3" = 0.5609502,
"Rt_rw_4" = 0.08409054,
"Rt_rw_5" = 0.3667386,
"Rt_rw_6" = 0.03206019,
"Rt_rw_7" = -0.01544258,
"Rt_rw_8" = 0.1349962,
"Rt_rw_9" = 0.08671713
)
formals(fit_spline_rf_fit)
pars_obs <- list(phi_cases = 1, k_cases = 2, phi_death = 1, k_death = 2, exp_noise = 1e6)
pars_obs$sero_det <- sero_det("igg", igg_sens = 0.95, igg_conv = 13.3)
pcr_sens <- 0.95
pcr_det <- c(9.206156e-13, 9.206156e-13, 3.678794e-01, 9.645600e-01,
9.575796e-01, 9.492607e-01, 9.393628e-01, 9.276090e-01,
9.136834e-01, 8.972309e-01, 8.778578e-01, 8.551374e-01,
8.286197e-01, 7.978491e-01, 7.623916e-01, 7.218741e-01,
6.760375e-01, 6.248060e-01, 5.683688e-01, 5.072699e-01,
4.525317e-01, 4.036538e-01, 3.600134e-01, 3.210533e-01,
2.862752e-01, 2.552337e-01, 2.275302e-01, 2.028085e-01,
1.807502e-01, 1.610705e-01, 1.435151e-01, 1.278563e-01,
1.138910e-01, 1.014375e-01, 9.033344e-02)
pcr_det <- (pcr_det/max(pcr_det))*pcr_sens
pars_obs$sero_df <- data.frame(
sero_df_start = as.Date(c("2020-07-04","2020-07-18")),
sero_df_end = as.Date(c("2020-07-27","2020-08-10")),
sero_df_pos = as.numeric(as.integer(c(0.021*4258, 0.106*4258))),
sero_df_samples = c(4258,4258)
)
